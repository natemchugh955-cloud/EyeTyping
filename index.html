<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Eye Typing Prototype</title>
  <style>
    body { font-family: Arial, sans-serif; text-align: center; padding: 20px; }
    #prompt { font-size: 24px; margin: 20px; }
    #output { font-size: 20px; margin-top: 30px; }
    video { display: none; }
    button { font-size: 18px; margin: 10px; padding: 10px 20px; }
    .yesBtn { background-color: #4CAF50; color: white; }
    .noBtn { background-color: #f44336; color: white; }
  </style>
</head>
<body>
  <h2>Eye Typing Prototype (Eye + Buttons Test)</h2>
  <div id="prompt">Look UP for 3 seconds to start</div>
  <video id="video" autoplay playsinline></video>
  <button class="yesBtn" onclick="yes()">YES (look up)</button>
  <button class="noBtn" onclick="no()">NO (look down)</button>
  <div id="output"></div>

  <script src="https://cdn.jsdelivr.net/npm/@vladmandic/face-api/dist/face-api.min.js"></script>
  <script>
    const vowels = ["A","E","I","O","U"];
    const consonants = ["T","N","S","H","R","D","L","C","M","W","F","G","Y","P","B","V","J","K","X","Q","Z"];
    let dictionary = [];

    // Load words.txt dictionary
    fetch("words.txt")
      .then(r => r.text())
      .then(text => {
        dictionary = text.split(/\r?\n/).map(w => w.trim()).filter(Boolean);
        console.log("Loaded", dictionary.length, "words into dictionary");
      });

    let sentence = "";
    let currentWord = "";
    let step = "idle";
    let letterIndex = 0;
    let predictedNextLetter = null;

    // Eye detection setup
    const video = document.getElementById("video");
    let upCounter = 0, downCounter = 0, frameThreshold = 15;

    Promise.all([
      faceapi.nets.tinyFaceDetector.loadFromUri("https://cdn.jsdelivr.net/npm/@vladmandic/face-api/model/"),
      faceapi.nets.faceLandmark68TinyNet.loadFromUri("https://cdn.jsdelivr.net/npm/@vladmandic/face-api/model/")
    ]).then(startVideo);

    function startVideo() {
      navigator.mediaDevices.getUserMedia({ video: true }).then(stream => {
        video.srcObject = stream;
      });
    }

    video.addEventListener("play", () => {
      const interval = setInterval(async () => {
        const detections = await faceapi.detectSingleFace(video, new faceapi.TinyFaceDetectorOptions()).withFaceLandmarks(true);
        if (detections) {
          const landmarks = detections.landmarks;
          const leftEye = landmarks.getLeftEye();
          const rightEye = landmarks.getRightEye();

          let avgY = (leftEye[1].y + rightEye[1].y) / 2;
          let avgX = (leftEye[0].x + rightEye[3].x) / 2;

          if (avgY < landmarks.positions[27].y - 10) { // look up
            upCounter++;
            downCounter = 0;
            if (upCounter > frameThreshold) {
              yes();
              upCounter = 0;
            }
          } else if (avgY > landmarks.positions[27].y + 10) { // look down
            downCounter++;
            upCounter = 0;
            if (downCounter > frameThreshold) {
              no();
              downCounter = 0;
            }
          }
        }
      }, 100);
    });

    // Flow functions
    function yes() {
      if (step === "idle") {
        step = "askVowel";
        updatePrompt("Does it start with a vowel? (YES=Up, NO=Down)");
      } else if (step === "askVowel") {
        step = "vowel";
        letterIndex = 0;
        showNextLetter();
      } else if (step === "consonant" || step === "vowel") {
        addLetter(step === "vowel" ? vowels[letterIndex] : consonants[letterIndex]);
      } else if (step === "predictLetter") {
        addLetter(predictedNextLetter);
        predictedNextLetter = null;
      } else if (step === "askNextWord") {
        sentence += currentWord + " ";
        currentWord = "";
        step = "askVowel";
        updateOutput();
        updatePrompt("Next word: Does it start with a vowel?");
      }
    }

    function no() {
      if (step === "askVowel") {
        step = "consonant";
        letterIndex = 0;
        showNextLetter();
      } else if (step === "consonant" || step === "vowel") {
        letterIndex++;
        showNextLetter();
      } else if (step === "predictLetter") {
        predictedNextLetter = null;
        step = "askVowel";
        updatePrompt("Is it a vowel? (YES/NO)");
      } else if (step === "askNextWord") {
        speakSentence();
        resetAll();
      }
    }

    function showNextLetter() {
      let list = (step === "consonant") ? consonants : vowels;
      if (letterIndex < list.length) {
        updatePrompt("Letter: " + list[letterIndex] + " ? (YES/NO)");
      } else {
        step = "askVowel";
        updatePrompt("Restart letter selection? Vowel?");
      }
    }

    function addLetter(letter) {
      currentWord += letter;
      updateOutput();

      if (dictionary.includes(currentWord.toLowerCase())) {
        step = "askNextWord";
        updatePrompt("Word is '" + currentWord + "'. Next word?");
        return;
      }

      // Prediction
      let possible = dictionary.filter(w => w.startsWith(currentWord.toLowerCase()));
      if (possible.length > 0) {
        let nextLetters = {};
        for (let w of possible) {
          if (w.length > currentWord.length) {
            let next = w[currentWord.length].toUpperCase();
            nextLetters[next] = (nextLetters[next] || 0) + 1;
          }
        }
        let best = Object.entries(nextLetters).sort((a, b) => b[1] - a[1])[0];
        if (best) {
          predictedNextLetter = best[0];
          step = "predictLetter";
          updatePrompt("Predict: Is next letter '" + predictedNextLetter + "'?");
          return;
        }
      }

      step = "askVowel";
      updatePrompt("Is it a vowel? (YES/NO)");
    }

    function updatePrompt(text) {
      document.getElementById("prompt").innerText = text;
    }

    function updateOutput() {
      document.getElementById("output").innerText = "Current: " + sentence + currentWord;
    }

    function resetAll() {
      sentence = "";
      currentWord = "";
      step = "idle";
      updatePrompt("Look UP for 3 seconds to start");
      updateOutput();
    }

    function speakSentence() {
      const utterance = new SpeechSynthesisUtterance(sentence.trim());
      speechSynthesis.speak(utterance);
    }
  </script>
</body>
</html>


