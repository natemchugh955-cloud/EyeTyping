<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Eye Controlled Letter Predictor</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f2f2f2;
      text-align: center;
      margin: 0;
      padding: 0;
    }
    #app {
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 10px;
    }
    .prompt {
      font-size: 1.5em;
      margin: 10px 0;
      font-weight: bold;
    }
    .letter {
      font-size: 3em;
      margin: 20px 0;
      padding: 15px;
      border: 2px solid #333;
      border-radius: 10px;
      background: #fff;
      width: 80%;
    }
    .info {
      margin: 10px 0;
      font-size: 1.2em;
    }
    .buttons {
      display: flex;
      justify-content: center;
      gap: 15px;
      margin: 15px 0;
    }
    button {
      font-size: 1.2em;
      padding: 10px 20px;
      border-radius: 10px;
      border: none;
      cursor: pointer;
      box-shadow: 2px 2px 6px rgba(0,0,0,0.2);
    }
    .yes { background: #4CAF50; color: white; }
    .no { background: #f44336; color: white; }
    .calibrate { background: #2196F3; color: white; }
    #debug {
      text-align: left;
      font-family: monospace;
      font-size: 0.9em;
      background: #000;
      color: #0f0;
      padding: 10px;
      margin-top: 20px;
      width: 90%;
      max-width: 600px;
      border-radius: 8px;
      height: 200px;
      overflow-y: auto;
    }
    video {
      display: none; /* hide raw camera feed */
    }
  </style>
</head>
<body>
  <div id="app">
    <div class="prompt" id="prompt">Prompt will appear here</div>
    <div class="letter" id="letter">_</div>
    <div class="info">Sentence: <span id="sentence"></span></div>
    <div class="info">Predicted Next Letter: <span id="prediction"></span></div>
    <div class="buttons">
      <button class="yes" onclick="handleYes()">Yes</button>
      <button class="no" onclick="handleNo()">No</button>
    </div>
    <div class="buttons">
      <button class="calibrate" onclick="calibrate('up')">Calibrate Up</button>
      <button class="calibrate" onclick="calibrate('down')">Calibrate Down</button>
    </div>
    <div id="debug"></div>
    <video id="video" autoplay playsinline></video>
  </div>

  <script>
    // ------------------------
    // Dictionaries
    // ------------------------
    let dictionary = new Set();
    let customDictionary = new Set();

    fetch("words.txt")
      .then(res => res.text())
      .then(text => {
        text.split(/\r?\n/).forEach(word => {
          if (word.trim()) dictionary.add(word.trim().toLowerCase());
        });
        logDebug(`Loaded ${dictionary.size} words from words.txt`);
      });

    function finalizeWord(word) {
      const lower = word.toLowerCase();
      if (dictionary.has(lower) || customDictionary.has(lower)) {
        logDebug(`Word recognized: ${word}`);
      } else {
        customDictionary.add(lower);
        logDebug(`Added new word to custom dictionary: ${word}`);
      }
    }

    function getNextLetterPrediction(prefix) {
      prefix = prefix.toLowerCase();
      const allWords = [...dictionary, ...customDictionary];
      let freq = {};
      allWords.forEach(w => {
        if (w.startsWith(prefix) && w.length > prefix.length) {
          let nextChar = w[prefix.length];
          freq[nextChar] = (freq[nextChar] || 0) + 1;
        }
      });
      let sorted = Object.entries(freq).sort((a,b)=>b[1]-a[1]);
      return sorted.length > 0 ? sorted.map(x=>x[0].toUpperCase()) : [];
    }

    // ------------------------
    // State
    // ------------------------
    let currentSentence = "";
    let currentWord = "";
    let step = "start";
    let letterIndex = 0;

    const vowels = ["A","E","I","O","U"];
    const consonants = ["T","N","S","H","R","D","L","C","M","F","W","G","Y","P","B","V","K","X","J","Q","Z"];

    // ------------------------
    // UI Helpers
    // ------------------------
    function updateUI(prompt, letter, prediction) {
      document.getElementById("prompt").textContent = prompt;
      document.getElementById("letter").textContent = letter || "_";
      document.getElementById("sentence").textContent = currentSentence;
      document.getElementById("prediction").textContent = prediction || "";
    }

    function logDebug(msg) {
      const debugBox = document.getElementById("debug");
      debugBox.innerHTML += msg + "<br>";
      debugBox.scrollTop = debugBox.scrollHeight;
      console.log(msg);
    }

    // ------------------------
    // Prediction flow
    // ------------------------
    function startFlow() {
      step = "start";
      updateUI("Would you like to start?", "", "");
    }

    function handleYes() {
      if (step === "start") {
        step = "isVowel";
        updateUI("Does it start with a vowel?", "", "");
        return;
      }
      if (step === "isVowel") {
        letterIndex = 0;
        step = "vowels";
        askNextVowel();
        return;
      }
      if (step === "vowels") {
        currentWord += vowels[letterIndex];
        afterLetter();
        return;
      }
      if (step === "consonants") {
        currentWord += consonants[letterIndex];
        afterLetter();
        return;
      }
      if (step === "predict") {
        let preds = getNextLetterPrediction(currentWord);
        if (preds.length > 0) {
          currentWord += preds[0];
          afterLetter();
        } else {
          finalizeWord(currentWord);
          currentSentence += (currentSentence ? " " : "") + currentWord;
          currentWord = "";
          step = "start";
          updateUI("Next word?", "", "");
        }
        return;
      }
    }

    function handleNo() {
      if (step === "isVowel") {
        letterIndex = 0;
        step = "consonants";
        askNextConsonant();
        return;
      }
      if (step === "vowels") {
        letterIndex++;
        askNextVowel();
        return;
      }
      if (step === "consonants") {
        letterIndex++;
        askNextConsonant();
        return;
      }
      if (step === "predict") {
        finalizeWord(currentWord);
        currentSentence += (currentSentence ? " " : "") + currentWord;
        currentWord = "";
        step = "start";
        updateUI("Next word?", "", "");
        return;
      }
    }

    function askNextVowel() {
      if (letterIndex < vowels.length) {
        updateUI("Is the letter " + vowels[letterIndex] + "?", vowels[letterIndex], "");
      } else {
        step = "predict";
        let preds = getNextLetterPrediction(currentWord);
        updateUI("Predicting next letter", "", preds[0] || "No prediction");
      }
    }

    function askNextConsonant() {
      if (letterIndex < consonants.length) {
        updateUI("Is the letter " + consonants[letterIndex] + "?", consonants[letterIndex], "");
      } else {
        step = "predict";
        let preds = getNextLetterPrediction(currentWord);
        updateUI("Predicting next letter", "", preds[0] || "No prediction");
      }
    }

    function afterLetter() {
      let preds = getNextLetterPrediction(currentWord);
      if (preds.length > 0) {
        step = "predict";
        updateUI("Predicting next letter", "", preds[0]);
      } else {
        // Word might be finished
        if (dictionary.has(currentWord.toLowerCase()) || customDictionary.has(currentWord.toLowerCase())) {
          finalizeWord(currentWord);
          currentSentence += (currentSentence ? " " : "") + currentWord;
          currentWord = "";
          step = "start";
          updateUI("Next word?", "", "");
        } else {
          step = "isVowel";
          updateUI("Does the next letter start with a vowel?", "", "");
        }
      }
    }

    // ------------------------
    // Eye Detection (simplified stub)
    // ------------------------
    let upFrames = 0, downFrames = 0;
    const requiredFrames = 15;

    function calibrate(dir) {
      logDebug(`Calibrated ${dir}`);
    }

    setInterval(() => {
      let rand = Math.random();
      if (rand > 0.97) {
        upFrames++;
        if (upFrames >= requiredFrames) {
          logDebug("Detected LOOK UP (YES)");
          handleYes();
          upFrames = 0;
        }
      } else if (rand < 0.03) {
        downFrames++;
        if (downFrames >= requiredFrames) {
          logDebug("Detected LOOK DOWN (NO)");
          handleNo();
          downFrames = 0;
        }
      } else {
        upFrames = 0;
        downFrames = 0;
      }
    }, 100);

    // ------------------------
    // Start
    // ------------------------
    startFlow();
  </script>
</body>
</html>
