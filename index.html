<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Eye Typing Prototype — Mobile Friendly</title>
<style>
  body {
    font-family: Arial, sans-serif;
    padding: 12px;
    margin: 0;
    background: #f9f9f9;
    text-align: center;
  }

  #prompt {
    font-size: 20px;
    margin: 12px 0;
    font-weight: bold;
  }

  #letterBox {
    font-size: 64px;
    font-weight: bold;
    margin: 18px 0;
    padding: 20px;
    background: #fff;
    border: 2px solid #ddd;
    border-radius: 12px;
    min-height: 80px;
  }

  #output {
    font-size: 18px;
    margin: 12px 0;
    background: #fff;
    padding: 10px;
    border-radius: 10px;
  }

  #predictions {
    font-size: 18px;
    margin: 10px 0;
    background: #eef;
    padding: 8px;
    border-radius: 10px;
  }

  .button-row {
    display: flex;
    justify-content: center;
    flex-wrap: wrap;
    gap: 10px;
    margin: 16px 0;
  }

  button {
    flex: 1 1 40%;
    font-size: 20px;
    padding: 16px;
    border: none;
    border-radius: 12px;
    color: white;
    cursor: pointer;
  }

  #yesBtn {
    background: #28a745;
  }

  #noBtn {
    background: #dc3545;
  }

  #calibUpBtn {
    background: #007bff;
  }

  #calibDownBtn {
    background: #6f42c1;
  }

  #debug {
    font-size: 14px;
    color: #555;
    text-align: left;
    margin-top: 16px;
    padding: 10px;
    background: #fff3cd;
    border: 1px solid #ffeeba;
    border-radius: 8px;
    white-space: pre-wrap;
  }

  video {
    display: none;
  }
</style>
</head>
<body>
  <h1>Eye Typing Prototype — Mobile Friendly</h1>

  <div id="prompt">Press START to begin.</div>
  <div id="letterBox">—</div>

  <div id="output"></div>
  <div id="predictions"></div>

  <div class="button-row">
    <button id="yesBtn">YES (Look Up)</button>
    <button id="noBtn">NO (Look Down)</button>
  </div>

  <div class="button-row">
    <button id="calibUpBtn">Calibrate Up</button>
    <button id="calibDownBtn">Calibrate Down</button>
  </div>

  <div id="debug"></div>

  <video id="webcam" autoplay playsinline width="320" height="240"></video>

<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-core"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-converter"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-backend-webgl"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/facemesh"></script>

<script>
/* ================= Config ================= */
const vowels = ["A","E","I","O","U"];
const consonants = ["T","N","S","H","R","D","L","C","M","W","F","G","Y","P","B","V","J","K","X","Q","Z"];
let dictionary = [];

/* Load dictionary from words.txt */
async function loadDictionary() {
  try {
    const resp = await fetch("words.txt");
    const text = await resp.text();
    dictionary = text.split(/\r?\n/).map(w => w.trim().toLowerCase()).filter(w => w.length > 0);
    logDebug(`Loaded dictionary with ${dictionary.length} words.`);
  } catch (e) {
    logDebug("Failed to load dictionary, using fallback.");
    dictionary = ["hello","hi","have","hope","good","great","you","yes","no"];
  }
}

/* ================= Runtime state ================= */
let sentence = "";
let currentWord = "";
let step = "idle";
let letterIndex = 0;
let predictedLetters = [];
let predictedIndex = 0;

/* ================= DOM ================= */
const promptEl = document.getElementById("prompt");
const letterBox = document.getElementById("letterBox");
const outputEl = document.getElementById("output");
const predsEl = document.getElementById("predictions");
const debugEl = document.getElementById("debug");

/* ================= Helpers ================= */
function updatePrompt(t) { promptEl.innerText = t; }
function updateLetter(t) { letterBox.innerText = t || "—"; }
function updateOutput() {
  outputEl.innerHTML = `<strong>Sentence:</strong> ${sentence.trim()}<br/><strong>Current word:</strong> ${currentWord}`;
  predsEl.innerHTML = predictedLetters.length ? `<strong>Predicted next letters:</strong> ${predictedLetters.join(", ")}` : "";
}
function logDebug(msg) {
  debugEl.innerText += msg + "\n";
  debugEl.scrollTop = debugEl.scrollHeight;
}
function toLower(s) { return s ? s.toLowerCase() : s; }

/* Predictions */
function computePredictedLetters(prefix) {
  const p = toLower(prefix);
  const freq = {};
  for (const w of dictionary) {
    if (w.startsWith(p) && w.length > p.length) {
      const next = w[p.length].toUpperCase();
      freq[next] = (freq[next] || 0) + 1;
    }
  }
  return Object.entries(freq)
    .sort((a,b) => b[1] - a[1] || a[0].localeCompare(b[0]))
    .map(e => e[0]);
}
function isExactWord(prefix) {
  return dictionary.includes(toLower(prefix));
}

/* ================= Core Flow ================= */
function start() {
  sentence = "";
  currentWord = "";
  step = "askStart";
  predictedLetters = [];
  predictedIndex = 0;
  letterIndex = 0;
  updatePrompt("Start a new sentence? Look UP for YES.");
  updateLetter("—");
  updateOutput();
}

function resetAll() {
  sentence = "";
  currentWord = "";
  step = "idle";
  predictedLetters = [];
  predictedIndex = 0;
  letterIndex = 0;
  updatePrompt("Press START to begin.");
  updateLetter("—");
  updateOutput();
}

function addLetter(letter) {
  currentWord += letter;
  logDebug("Added letter: " + letter);
  updateOutput();

  if (isExactWord(currentWord)) {
    predictedLetters = computePredictedLetters(currentWord);
    predictedIndex = 0;
    step = "askNextWord";
    updatePrompt(`Word is "${currentWord}". Next word?`);
    return;
  }

  predictedLetters = computePredictedLetters(currentWord);
  predictedIndex = 0;
  if (predictedLetters.length > 0) {
    step = "predictLetter";
    updatePrompt(`Next letter "${predictedLetters[predictedIndex]}"?`);
    updateLetter(predictedLetters[predictedIndex]);
  } else {
    step = "askVowel";
    updatePrompt("No predictions. Is it a vowel?");
    updateLetter("?");
  }
}

/* YES behavior */
function handleYes() {
  switch(step) {
    case "askStart":
      step = "askVowel";
      updatePrompt("Is it a vowel?");
      break;
    case "askVowel":
      step = "vowel";
      letterIndex = 0;
      updatePrompt("Letter?");
      updateLetter(vowels[letterIndex]);
      break;
    case "vowel":
      addLetter(vowels[letterIndex]);
      break;
    case "consonant":
      addLetter(consonants[letterIndex]);
      break;
    case "predictLetter":
      if (predictedLetters[predictedIndex]) {
        addLetter(predictedLetters[predictedIndex]);
      }
      break;
    case "askNextWord":
      sentence += currentWord + " ";
      currentWord = "";
      predictedLetters = [];
      step = "askVowel";
      updatePrompt("Next word? Is it a vowel?");
      updateLetter("?");
      break;
  }
}

/* NO behavior */
function handleNo() {
  switch(step) {
    case "askStart":
      resetAll();
      break;
    case "askVowel":
      step = "consonant";
      letterIndex = 0;
      updatePrompt("Letter?");
      updateLetter(consonants[letterIndex]);
      break;
    case "vowel":
      letterIndex++;
      if (letterIndex < vowels.length) {
        updateLetter(vowels[letterIndex]);
      } else {
        step = "askVowel";
        updatePrompt("Is it a vowel?");
        updateLetter("?");
      }
      break;
    case "consonant":
      letterIndex++;
      if (letterIndex < consonants.length) {
        updateLetter(consonants[letterIndex]);
      } else {
        step = "askVowel";
        updatePrompt("Is it a vowel?");
        updateLetter("?");
      }
      break;
    case "predictLetter":
      predictedIndex++;
      if (predictedIndex < predictedLetters.length) {
        updateLetter(predictedLetters[predictedIndex]);
        updatePrompt(`Next letter "${predictedLetters[predictedIndex]}"?`);
      } else {
        step = "askVowel";
        updatePrompt("No more predictions. Is it a vowel?");
        updateLetter("?");
      }
      break;
    case "askNextWord":
      if (!predictedLetters || predictedLetters.length === 0) {
        predictedLetters = computePredictedLetters(currentWord);
        predictedIndex = 0;
      }
      if (predictedLetters.length > 0) {
        step = "predictLetter";
        updateLetter(predictedLetters[predictedIndex]);
        updatePrompt(`Next letter "${predictedLetters[predictedIndex]}"?`);
      } else {
        step = "askVowel";
        updatePrompt("Is it a vowel?");
        updateLetter("?");
      }
      break;
  }
}

/* ================= Eye detection (simplified with facemesh) ================= */
let model, video;
async function initWebcam() {
  video = document.getElementById("webcam");
  const stream = await navigator.mediaDevices.getUserMedia({ video: true });
  video.srcObject = stream;
  video.onloadedmetadata = () => { video.play(); };
  model = await facemesh.load();
  detectLoop();
}

async function detectLoop() {
  if (!model) return;
  const predictions = await model.estimateFaces({input: video});
  if (predictions.length > 0) {
    logDebug("Face detected");
  }
  requestAnimationFrame(detectLoop);
}

/* ================= Hookups ================= */
document.getElementById("yesBtn").onclick = handleYes;
document.getElementById("noBtn").onclick = handleNo;
document.getElementById("calibUpBtn").onclick = () => logDebug("Calibrate Up clicked");
document.getElementById("calibDownBtn").onclick = () => logDebug("Calibrate Down clicked");

loadDictionary().then(start);
initWebcam();
</script>
</body>
</html>







